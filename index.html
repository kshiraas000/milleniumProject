<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Stocks - Millennium</title>
    <link rel="stylesheet" href="static/styles.css">
    <script src="static/nav.js" defer></script>
  </head>  
    
<body>
    <div class="main">
    <div class="header"><h2>Order Entry System</h2></div>
    

    <div class="form-group">
        <select id="orderCategory">
            <option value="market">Market</option>
            <option value="limit">Limit</option>
            <option value="stop">Stop</option>
            <option value="stop-limit">Stop-Limit</option>
            <option value="trailing-stop">Trailing Stop</option>
          </select>
          
          <select id="orderType">
            <option value="buy">Buy</option>
            <option value="sell">Sell</option>
          </select>
          
          <input type="text" id="symbol" placeholder="Symbol">
          <input type="number" id="quantity" placeholder="Quantity">
          <input type="number" id="limitPrice" placeholder="Limit Price" style="display: none;">
          <input type="number" id="stopPrice" placeholder="Stop Price" style="display: none;">
          <input type="number" id="trailAmount" placeholder="Trailing Amount" style="display: none;">
          <button onclick="createOrder()">Create</button>
    </div>

    <div class="card">
      <h2>Stock Prediction</h2>
      <input type="text" id="stockSymbol" placeholder="Enter Stock Symbol">
      <div style="margin-top: 10px;">
        <button onclick="fetchPrediction()">Predict</button>
        <button onclick="retrainModel()">Train Model</button>
      </div>
      <div id="predictionResult" style="margin-top: 15px; font-weight: bold;"></div>
      <div id="retrainResult" style="margin-top: 10px; font-style: italic; color: #444;"></div>
      <p id="retrainTimestamp" style="color: #999; font-size: 0.9em;"></p>
    </div>

    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>Type</th>
          <th>Symbol</th>
          <th>Quantity</th>
          <th>State</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="ordersTableBody"></tbody>
    </table>
  </div>

  <script>
    document.getElementById("orderCategory").addEventListener("change", function () {
    const category = this.value;

    document.getElementById("limitPrice").style.display = (category === "limit" || category === "stop-limit") ? "inline-block" : "none";
    document.getElementById("stopPrice").style.display = (category === "stop" || category === "stop-limit") ? "inline-block" : "none";
    document.getElementById("trailAmount").style.display = (category === "trailing-stop") ? "inline-block" : "none";
    });
    document.getElementById("symbol").addEventListener("input", async function () {
      const symbol = this.value.toUpperCase();
      if (!symbol) return;

      // try {
      //   const res = await fetch(`http://localhost:5001/price/${symbol}`);
      //   const data = await res.json();
      //   if (data.price) {
      //     document.getElementById("livePrice").innerText = `Live Price: $${data.price}`;
      //   } else {
      //     document.getElementById("livePrice").innerText = "Symbol not found";
      //   }
      // } catch (err) {
      //   document.getElementById("livePrice").innerText = "";
      //   console.error("Price fetch failed:", err);
      // }
    });
    async function fetchOrders() {
      const res = await fetch("http://localhost:5001/orders");
      const orders = await res.json();
      const body = document.getElementById("ordersTableBody");
      body.innerHTML = "";
      orders.forEach(order => {
        body.innerHTML += `
          <tr>
            <td>${order.id}</td>
            <td>${order.order_type}</td>
            <td>${order.symbol}</td>
            <td>${order.quantity}</td>
            <td>${order.state}</td>
            <td class="actions">
              <button onclick="executeOrder(${order.id})">Execute</button>
              <button onclick="cancelOrder(${order.id})">Cancel</button>
            </td>
          </tr>`;
      });
    }

    async function createOrder() {
        const order_type = document.getElementById("orderCategory").value;
        const symbol = document.getElementById("symbol").value;
        const quantity = parseInt(document.getElementById("quantity").value);
        const limit_price = parseFloat(document.getElementById("limitPrice").value) || null;
        const stop_price = parseFloat(document.getElementById("stopPrice").value) || null;
        const trail_amount = parseFloat(document.getElementById("trailAmount").value) || null;

        await fetch("http://localhost:5001/orders", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
            order_type,
            symbol,
            quantity,
            limit_price,
            stop_price,
            trail_amount
            })
        });

        fetchOrders();
    }

    async function executeOrder(id) {
      await fetch(`http://localhost:5001/orders/${id}/execute`, { method: "PUT" });
      fetchOrders();
    }

    async function cancelOrder(id) {
      await fetch(`http://localhost:5001/orders/${id}/cancel`, { method: "PUT" });
      fetchOrders();
    }

    async function fetchPrediction() {
  const symbol = document.getElementById("stockSymbol").value.toUpperCase();
  const resultDiv = document.getElementById("predictionResult");

  if (!symbol) {
    resultDiv.innerText = "Please enter a stock symbol.";
    return;
  }

  resultDiv.innerText = "Fetching prediction... ⏳";

  try {
    const res = await fetch(`http://localhost:5001/predict/${symbol}`);
    const data = await res.json();

    if (data.error) {
      resultDiv.innerText = "Error: " + data.error;
      return;
    }

    let resultHTML = `<h3>Predicted Prices for ${symbol}</h3>`;
    resultHTML += `<p>Current Price: $${data.current_price}</p>`;
    resultHTML += `<p>Predicted Price (next 7 days): $${data.predicted_price}</p>`;
    resultHTML += `<p>Expected Change: $${data.expected_change}</p>`;
    resultHTML += `<p>Percentage Change: ${data.percentage_change}%</p>`;
    resultHTML += `<p>Trend: ${data.trend}</p>`;

    resultDiv.innerHTML = resultHTML;
  } catch (err) {
    resultDiv.innerText = "Prediction failed.";
    console.error(err);
  }
}

async function retrainModel() {
  const symbol = document.getElementById("stockSymbol").value.toUpperCase();
  const resultDiv = document.getElementById("retrainResult");

  if (!symbol) {
    resultDiv.innerText = "Please enter a stock symbol.";
    return;
  }

  resultDiv.innerText = "Training model... ⏳";

  try {
    const response = await fetch(`http://localhost:5001/train/${symbol}`, {
      method: "POST"
    });
    const data = await response.json();

    if (data.message) {
      resultDiv.innerText = data.message;
    } else if (data.error) {
      resultDiv.innerText = "Error: " + data.error;
    }
    document.getElementById("retrainTimestamp").innerText = `Last retrained at ${new Date().toLocaleTimeString()}`;
    
  } catch (error) {
    resultDiv.innerText = "Network error during training.";
    console.error(error);
  }
}

    fetchOrders();
  </script>
</body>
</html>